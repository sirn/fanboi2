language: python
dist: trusty
sudo: false

matrix:
  include:
    - python: "3.6"
      cache: pip
      before_script:
        - psql -c "create database fanboi2_docker;" -U postgres
      env:
        - POSTGRESQL_TEST_DATABASE=postgresql://postgres@localhost:5432/fanboi2
      install:
        - make .build/.build-test
      script:
        - make test

    - sudo: true
      services:
        - docker
      before_install:
        - docker build -t forloopend/fanboi2 .
      before_script:
        - psql -c "create database fanboi2_docker;" -U postgres
      script:
        - |
          docker run forloopend/fanboi2 \
            sh -c " \
              env \
                HOST_IP=\$(/sbin/ip route|awk '/default/ { print \$3 }') \
                POSTGRESQL_TEST_DATABASE=postgresql://postgres@\$HOST_IP:5432/fanboi2_docker \
              make test \
            "

notifications:
  email:
    recipients:
      - build@fanboi.ch
    on_success: always
    on_failure: always
