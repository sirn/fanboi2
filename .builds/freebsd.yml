---
image: freebsd/latest
packages:
  - node16
  - npm-node16
  - postgresql13-client
  - postgresql13-server
  - py39-pip
  - py39-sqlite3
  - python39
sources:
  - https://git.sr.ht/~sirn/fanboi2
tasks:
  - setup: |
      cd fanboi2/ || exit 1
      export PATH=$HOME/.local/bin:$PATH

      npm set prefix="$HOME/.local"
      npm install -g pnpm

      sudo service postgresql oneinitdb
      sudo sysrc postgresql_enable=YES
      sudo sysrc postgresql_flags="-l /var/log/postgresql.log"

      cat <<EOF | sudo tee /var/db/postgres/data13/pg_hba.conf
      local all all trust
      host all all 127.0.0.1/32 trust
      host all all ::1/128 trust
      EOF

      sudo touch /var/log/postgresql.log
      sudo chown postgres /var/log/postgresql.log
      sudo service postgresql start
      sudo -u postgres createuser -ds fanboi2
      sudo -u postgres createdb -U fanboi2 fanboi2_test
  - build: |
      cd fanboi2/ || exit 1
      export PATH=$HOME/.local/bin:$PATH
      export PYTHON=/usr/local/bin/python3.9
      pnpm install
      pnpm run gulp
  - test: |
      cd fanboi2/ || exit 1
      export PATH=$HOME/.local/bin:$PATH
      export VENVDIR=$HOME/venv
      export PYTHON=/usr/local/bin/python3.9
      export POSTGRESQL_TEST_DATABASE="postgresql://fanboi2:@localhost:5432/fanboi2_test"
      make test
